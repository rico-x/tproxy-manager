# Панель управления **TPROXY manager** (LuCI)

Веб-интерфейс LuCI для настройки TPROXY-перехвата трафика, редактирования конфигов Xray и управления обновлениями GEO-баз. Документ описывает все вкладки, поля и кнопки, а также подсказки и типичные проблемы.

> Файл: `/usr/lib/lua/luci/model/cbi/xray_tproxy/manage.lua`  
> Требуются права администратора (root) на роутере.

---

## Содержание

- [Навигация и общие элементы](#навигация-и-общие-элементы)
- [Вкладка **TPROXY**](#вкладка-tproxy)
  - [Статус сервиса](#статус-сервиса)
  - [Основные настройки](#основные-настройки)
    - [Интерфейсы и IPv6](#интерфейсы-и-ipv6)
    - [Порты и разделение TCP/UDP](#порты-и-разделение-tcpudp)
    - [Режимы по портам и источникам](#режимы-по-портам-и-источникам)
  - [Единый редактор списков](#единый-редактор-списков)
    - [Подсказки по форматам файлов](#подсказки-по-форматам-файлов)
    - [Быстрое добавление из DHCP-аренд](#быстрое-добавление-из-dhcpаренд)
  - [Дополнительные параметры](#дополнительные-параметры)
  - [Сохранение настроек](#сохранение-настроек)
- [Вкладка **XRAY**](#вкладка-xray)
  - [Статус сервиса](#статус-сервиса-1)
  - [Общий системный лог](#общий-системный-лог)
  - [Редактор JSON-конфигов Xray](#редактор-jsonконфигов-xray)
  - [Проверка конфигурации](#проверка-конфигурации)
- [Вкладка **Обновление геобаз**](#вкладка-обновление-геобаз)
  - [Список источников](#список-источников)
  - [Добавление/редактирование/удаление](#добавлениередактированиеудаление)
  - [Пакетное обновление и расписание (cron)](#пакетное-обновление-и-расписание-cron)
  - [Глобальное редактирование списка (JSON)](#глобальное-редактирование-списка-json)
- [Сообщения и подсказки на странице](#сообщения-и-подсказки-на-странице)
- [Советы по эксплуатации](#советы-по-эксплуатации)
- [Устранение неполадок](#устранение-неполадок)

---

## Навигация и общие элементы

Вверху — три вкладки-кнопки:

- **TPROXY** — настройка перехвата трафика и списков.
- **XRAY** — управление сервисом Xray и редактирование его JSON-конфигов.
- **Обновление геобаз** — управление источниками GEO (geoip/geosite), обновления и расписание.

**Защита от потери правок.** При переключении селекторов/вкладок с несохранённым текстом появится подтверждение.

**Место для скриншота навбара:**  
`![Навигация по вкладкам](docs/screenshots/01-navbar.png)`

---

## Вкладка **TPROXY**

### Статус сервиса
Блок «TPROXY»:

- Метки состояния: **работает / остановлен** и **в автозапуске / не в автозапуске**.
- Кнопки управления: **Запустить**, **Остановить**, **Добавить/Убрать из автозапуска**.

`![Статус TPROXY](docs/screenshots/02-tproxy-status.png)`

---

### Основные настройки

#### Интерфейсы и IPv6
- Чекбокс **IPv6** — включает обработку IPv6.
- Список **интерфейсов** для перехвата (lo и wwan-зона автоматически исключаются, чтобы не перехватывать WAN/модем).

`![Интерфейсы и IPv6](docs/screenshots/03-interfaces-ipv6.png)`

#### Порты и разделение TCP/UDP
- Режим **общего порта** или чекбокс **«Разделить TCP/UDP»** с двумя отдельными полями.
- Валидация: допускаются только значения **1..65535**.  
  При включённом разделении оба поля обязательны.

`![Порты TPROXY](docs/screenshots/04-ports-split.png)`

#### Режимы по портам и источникам
- **Режим по портам (`port_mode`)**:
  - `bypass` — перечисленные порты обходят прокси; остальные — через прокси.
  - `only` — перечисленные порты идут через прокси; остальные — напрямую.
- **Режим по источникам (`src_mode`)**:
  - `off` — списки источников не используются.
  - `only` — источники из *src_only* — через прокси.
  - `bypass` — источники из *src_bypass* — напрямую.

Переключение селекторов перезагружает текущую вкладку с сохранением выбора файлов.

`![Режимы портов и источников](docs/screenshots/05-modes.png)`

---

### Единый редактор списков

Выпадающий список «**Файл для редактирования**» предлагает релевантные файлы из UCI:

- `ports_file` — список портов (смысл зависит от `port_mode`).
- `bypass_v4_file` / `bypass_v6_file` — адреса/сети, **которые НЕ проксируются**.
- `src_only_v4_file` / `src_only_v6_file` — источники, **которые идут через прокси**.
- `src_bypass_v4_file` / `src_bypass_v6_file` — источники, **которые идут напрямую**.

На этой панели:
- Основной **текстовый редактор** (с подсветкой проблемных строк).
- Кнопка **«Сохранить файл»** — мгновенная запись на диск (атомарно).
- Краткое описание смысла выбранного файла.

`![Редактор списков](docs/screenshots/06-unified-editor.png)`

#### Подсказки по форматам файлов

- Поддерживаются IPv4/IPv6 адреса и CIDR (`a.b.c.d/nn`, `2001:db8::/32`).
- Пустые строки и строки, начинающиеся с `#` или `;`, **игнорируются**.
- При подозрительных строках внизу блока появляется список с номерами.

`![Валидация списков](docs/screenshots/07-unified-validate.png)`

#### Быстрое добавление из DHCP-аренд

Ниже редактора — сворачиваемый список активных **DHCP-аренд** (из `/tmp/dhcp.leases`):

- Кнопки **`+ only`** / **`+ bypass`** моментально добавляют IP в соответствующий файл
  (`src_only_v4_file` или `src_bypass_v4_file`), без ручного редактирования.

`![DHCP аренды — быстрое добавление](docs/screenshots/08-dhcp-quick-add.png)`

---

### Дополнительные параметры

Сворачиваемый блок «Дополнительные настройки»:

- **Логирование** (вкл/выкл).
- **nft_table**, **fwmark_tcp/udp**, **rttab_tcp/udp** — системные параметры меток и таблиц маршрутизации.
- Пути к используемым файлам списков: `ports_file`, `bypass_*`, `src_only_*`, `src_bypass_*`.

`![Дополнительные настройки](docs/screenshots/09-advanced.png)`

---

### Сохранение настроек

Внизу вкладки:

- **Сохранить настройки TPROXY** — записывает параметры в UCI (без автоперезапуска сервиса).
- **Отменить изменения** — просто перегружает страницу, не записывая правки.

> Отдельные действия (добавление IP из DHCP, сохранение файлов списков) применяются сразу — об этом сообщает зелёное информационное сообщение.

`![Сохранение TPROXY](docs/screenshots/10-save-row.png)`

---

## Вкладка **XRAY**

### Статус сервиса

Аналогично TPROXY: состояние, автозапуск, кнопки **Запустить / Остановить / Добавить/Убрать из автозапуска**.

`![Статус Xray](docs/screenshots/11-xray-status.png)`

### Общий системный лог

Сворачиваемая панель **«Общий лог (logread)»**:

- Показаны последние строки `logread`.
- **Обновить** — перезагрузка блока лога.
- **Очистить** — перезапуск системного лог-демона (`/etc/init.d/log restart`).

`![Лог системы](docs/screenshots/12-logread.png)`

### Редактор JSON-конфигов Xray

Раздел «Xray (JSON-файлы в `/etc/xray`)»:


- Создание нового файла по имени `*.json`.
- Выпадающий список для выбора текущего файла.
- **Текстовый редактор** с проверкой **JSONC** (JSON + комментарии).
- **Сохранить** — атомарная запись на диск с валидацией:
  - Комментарии удаляются на время разбора, так что удобные `//` и `/* ... */` допустимы.
- **Удалить** — удаляет выбранный JSON-файл.

> **Важно:** автоматического перезапуска Xray при сохранении нет. Используйте кнопки управления сервисом в блоке «Статус» при необходимости.

`![Редактор JSON Xray](docs/screenshots/13-json-editor.png)`

### Проверка конфигурации

Кнопка **«Проверить конфигурацию»** выполняет:

```
xray -test -format json -confdir /etc/xray > /tmp/xray_test.log 2>&1
```

Результат отображается в сворачиваемой панели «Результат последней проверки». Есть кнопка **Очистить** для этого журнала.

`![Проверка конфигурации Xray](docs/screenshots/14-xray-test.png)`

---

## Вкладка **Обновление геобаз**

### Список источников

Таблица с колонками: **#**, **Название**, **URL**, **Путь назначения**, **Дата обновления (mtime)**, **Действия**.

Действия для каждой строки:

- **Обновить** — скачать файл в указанный путь (используются `curl` или `wget`).
- **Редактировать** — открыть форму редактирования строки.
- **Удалить** — удалить источник из списка.

`![Список источников GEO](docs/screenshots/15-geo-list.png)`

### Добавление/редактирование/удаление

Ниже — форма **Добавить источник** (Название, URL, Путь).  
При редактировании выбранная строка открывается в аналогичной форме.

> Скрипт загрузки будет создан/обновлён автоматически. Текущий скрипт: `/usr/bin/xray-geo-update.sh`.

`![Добавление/редактирование источника](docs/screenshots/16-geo-edit.png)`

### Пакетное обновление и расписание (cron)

Внизу таблицы:

- **Обновить все** — последовательная загрузка всех источников (с логированием через `logger` c тегом `xray-geoip-update`).
- Поле **Расписание (cron)** и пресеты — установка задания в `/etc/crontabs/root` с меткой `# xray-geo-update`.
  - **Создать/обновить автозапуск** — перезаписывает/добавляет cron-строку и перезапускает `cron`.
  - **Удалить автозапуск** — удаляет запись для обновлений и перезапускает `cron`.
- Под полем расписания — человекочитаемая подсказка («каждый день в 05:00» и т. п.).

`![Cron и массовое обновление](docs/screenshots/17-geo-cron.png)`

### Глобальное редактирование списка (JSON)

Сворачиваемый блок с сырьём `geo-sources.conf` (JSON/JSONC):

- **Сохранить список** — валидирует и сохраняет файл конфигурации источников.
- **Пересоздать скрипт** — перегенерирует `/usr/bin/xray-geo-update.sh`.

`![Глобальное редактирование GEO JSON](docs/screenshots/18-geo-json.png)`

---

## Сообщения и подсказки на странице

- **Информационные сообщения** (зелёные) автоматически исчезают из DOM через ~5 секунд.
- **Ошибки** (красные) имеют **TTL 60 секунд**: если новых ошибок нет, «вечные» сообщения автоочищаются, чтобы не пугать после исправлений.
- Сообщения об ошибках/инфо сбрасываются корректно при навигации внутри формы.

`![Сообщения на странице](docs/screenshots/19-messages.png)`

---

## Советы по эксплуатации

- **Перезапуск сервисов** выполняйте осознанно:
  - TPROXY обычно требует перезапуска для применения сетевых правил.
  - Xray после изменения JSON перезапускается вручную (кнопками статуса).
- **Бэкапы**: перед активными изменениями сохраните копии файлов из `/etc/xray` и путь файлов списков из «Дополнительных настроек».
- **Правка списков**: не добавляйте комментарии в конце строки после адреса/сети — используйте отдельные строки, начинающиеся с `#` или `;`.
- **Интерфейсы**: WAN/WWAN/модемные интерфейсы не предлагаются для перехвата, чтобы не зацикливать трафик.

---

## Устранение неполадок

1. **«Некорректный JSON (ошибка разбора)»**  
   Проверьте запятые/скобки. Комментарии допустимы, но синтаксис JSON внутри должен оставаться валидным.

2. **Порты не принимаются**  
   Диапазон строго **1..65535**. В режиме раздельных TCP/UDP оба поля обязательны.

3. **Обновление GEO не работает**  
   Убедитесь, что установлен `curl` или `wget`. Проверьте доступность URL и права записи по пути `dest`.

4. **Сервис не запускается**  
   Проверьте лог: `logread | tail -n 200` (см. вкладку XRAY → Общий лог), а также результат проверки каталога конфигурации Xray.

5. **Cron не срабатывает**  
   Посмотрите содержимое `/etc/crontabs/root` и убедитесь, что там есть строка с `# xray-geo-update`. Проверьте, что запущен `cron`.

6. **Списки источников не обновляются**  
   Проверьте `mtime` файлов назначения и системный лог по тегу `xray-geoip-update`.
