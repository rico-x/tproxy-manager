#!/bin/sh
# postinst for tproxy-manager
# - выполняет uci-defaults (создание /etc/tproxy-manager/* и UCI-значений, только если отсутствуют)
# - безопасно запускает /usr/bin/optimize-sysctl.sh и /usr/bin/setup-bbr.sh (ошибки игнорируются)
# - включает и стартует сервис /etc/init.d/tproxy-manager, если есть

[ -n "$IPKG_INSTROOT" ] && exit 0

LOGTAG="tproxy-manager-postinst"

# 1) Прогнать uci-defaults нашего пакета (если есть), логировать и не валиться на ошибках
if [ -d /etc/uci-defaults ]; then
  for f in /etc/uci-defaults/*tproxy_manager*; do
    [ -f "$f" ] || continue
    ( . "$f" ) >"/tmp/$(basename "$f").log" 2>&1 \
      || logger -t "$LOGTAG" "uci-defaults $(basename "$f") exited non-zero (ignored)"
    rm -f "$f"
  done
fi

# 2) Безопасно выполнить дополнительные скрипты без параметров (если существуют)
run_safe() {
  _s="$1"
  if [ -x "$_s" ]; then
    /bin/sh "$_s" >"/tmp/$(basename "$_s").postinst.log" 2>&1 \
      || logger -t "$LOGTAG" "$(basename "$_s") exited non-zero (ignored)"
  fi
}
run_safe /usr/bin/optimize-sysctl.sh
run_safe /usr/bin/setup-bbr.sh

# 3) Включить и запустить сервис (если есть), ошибки не фатальны
if [ -x /etc/init.d/tproxy-manager ]; then
  /etc/init.d/tproxy-manager enable >/dev/null 2>&1 \
    || logger -t "$LOGTAG" "enable failed (ignored)"
  /etc/init.d/tproxy-manager start  >/dev/null 2>&1 \
    || logger -t "$LOGTAG" "start failed (ignored)"
fi

exit 0