#!/bin/sh
# Generate /etc/sysctl.d/66-tproxy-manager.conf with only supported sysctls

set -eu

TARGET_DIR="/etc/sysctl.d"
TARGET_FILE="$TARGET_DIR/66-tproxy-manager.conf"
TMP_FILE="$(mktemp /tmp/sysctl.tproxy.XXXXXX)"

# Параметры (значения без кавычек; диапазоны — одной строкой)
PARAMS='
net.core.rmem_max=67108864
net.core.wmem_max=67108864
net.core.wmem_default=2097152
net.core.netdev_max_backlog=10240
net.core.somaxconn=8192
net.ipv4.tcp_syncookies=1
net.ipv4.tcp_tw_reuse=1
net.ipv4.tcp_fin_timeout=30
net.ipv4.tcp_keepalive_time=1200
net.ipv4.tcp_keepalive_probes=5
net.ipv4.tcp_keepalive_intvl=30
net.ipv4.tcp_max_syn_backlog=10240
net.ipv4.tcp_fastopen=3
net.ipv4.tcp_mtu_probing=1
net.ipv4.tcp_slow_start_after_idle=0
net.ipv4.ip_local_port_range=1024 45000
'

mkdir -p "$TARGET_DIR"
printf '# Auto-generated by tproxy-manager\n' > "$TMP_FILE"

APPLIED_LIST="/tmp/sysctl_applied.$$.list"
: > "$APPLIED_LIST"

# Применяем по одному и сохраняем только успешные
echo "$PARAMS" | while IFS= read -r line; do
  [ -n "$line" ] || continue
  case "$line" in \#*) continue ;; esac

  param="${line%%=*}"
  value="${line#*=}"

  # Очистка возможных кавычек вокруг значения
  case "$value" in
    \"*\" ) value="${value#\"}"; value="${value%\"}";;
    \'*\' ) value="${value#\'}"; value="${value%\'}";;
  esac

  if sysctl -w "$param=$value" >/dev/null 2>&1; then
    printf '%s=%s\n' "$param" "$value" >> "$TMP_FILE"
    printf '%s=%s\n' "$param" "$value" >> "$APPLIED_LIST"
  fi
done

# Переносим итоговый файл
mv "$TMP_FILE" "$TARGET_FILE"
chmod 0644 "$TARGET_FILE"

# Применяем
if [ -x /etc/init.d/sysctl ]; then
  /etc/init.d/sysctl reload >/dev/null 2>&1 || true
else
  sysctl -p "$TARGET_FILE" >/dev/null 2>&1 || true
fi

echo "[+] Готово: $(wc -l < "$TARGET_FILE") строк в $TARGET_FILE (включая заголовок)."
echo "[+] Применённые параметры:"
cat "$APPLIED_LIST"

rm -f "$APPLIED_LIST"